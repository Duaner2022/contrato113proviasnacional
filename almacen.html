<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almac√©n y Obligaciones | Contrato 113</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { background-color: #f4f6f9; padding-bottom: 80px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header-almacen { background: linear-gradient(90deg, #0043a8 0%, #0d6efd 100%); color: white; padding: 15px 0; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .progress-bar { transition: width 1.5s ease-in-out; font-weight: bold; }
        
        /* Estilos Tablas */
        .fila-kit { background-color: #e7f1ff !important; font-weight: bold; border-left: 4px solid #0d6efd; }
        .text-faltante { color: #dc3545; font-weight: 700; }
        .text-completo { color: #adb5bd; font-size: 0.9em; }
        .search-box { border-radius: 20px; }

        /* Botones */
        .btn-action { font-size: 0.8rem; margin-right: 4px; margin-bottom: 5px; border-radius: 4px; }
        .btn-whatsapp { background-color: #25D366; color: white; border: none; }
        .btn-excel { background-color: #217346; color: white; border: none; }
        .btn-pdf { background-color: #b30b00; color: white; border: none; }

        /* Badges de Estado Obligaciones */
        .badge-pendiente { background-color: #dc3545; color: white; } /* Rojo */
        .badge-proceso { background-color: #ffc107; color: black; }   /* Amarillo */
        .badge-cumplido { background-color: #198754; color: white; }  /* Verde */
    </style>
</head>
<body>

    <div class="header-almacen">
        <div class="container d-flex justify-content-between align-items-center">
            <h4 class="m-0"><i class="fas fa-clipboard-list"></i> CONTROL 113</h4>
            <a href="index.html" class="btn btn-light btn-sm fw-bold shadow-sm"><i class="fas fa-home"></i> Inicio</a>
        </div>
    </div>

    <div class="container">

        <div class="card-box border-start border-4 border-warning" id="seccion-obligaciones">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-dark m-0"><i class="far fa-calendar-alt text-warning"></i> Control de Obligaciones</h5>
                <span class="badge bg-warning text-dark">Plazos</span>
            </div>

            <div class="mb-2">
                <button onclick="exportarExcel('tabla-obligaciones', 'Reporte_Obligaciones')" class="btn btn-excel btn-action"><i class="fas fa-file-excel"></i> Excel</button>
                <button onclick="imprimirTabla('seccion-obligaciones')" class="btn btn-secondary btn-action"><i class="fas fa-print"></i> Imprimir</button>
            </div>

            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0" id="tabla-exportar-obligaciones" style="font-size: 0.9rem;">
                    <thead class="table-light">
                        <tr>
                            <th width="5%" class="text-center">Item</th>
                            <th width="45%">Obligacion</th>
                            <th width="15%" class="text-center">Fecha_Limite</th>
                            <th width="15%" class="text-center">Fecha_Presentacion</th>
                            <th width="20%" class="text-center">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-obligaciones">
                        <tr><td colspan="5" class="text-center py-3 text-muted">Cargando cronograma...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>


        <div class="card-box" id="seccion-lote1">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="text-primary m-0"><i class="fas fa-truck-loading"></i> Lote 1: Estructuras</h5>
                <span class="badge bg-light text-dark border">En tiempo real</span>
            </div>
            
            <div class="progress" style="height: 25px; margin-bottom: 15px; border-radius: 10px; background-color: #e9ecef;">
                <div id="barra-lote1" class="progress-bar bg-secondary" role="progressbar" style="width: 0%;">Cargando...</div>
            </div>

            <div class="mb-3 d-flex flex-wrap">
                <button onclick="enviarWhatsApp('Lote 1', 'tabla-lote1')" class="btn btn-whatsapp btn-action"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                <button onclick="exportarExcel('tabla-exportar-lote1', 'Reporte_Lote1')" class="btn btn-excel btn-action"><i class="fas fa-file-excel"></i> Excel</button>
                <button onclick="exportarPDF('tabla-exportar-lote1', 'Reporte Lote 1')" class="btn btn-pdf btn-action"><i class="fas fa-file-pdf"></i> PDF</button>
                <button onclick="imprimirTabla('seccion-lote1')" class="btn btn-secondary btn-action"><i class="fas fa-print"></i> Imprimir</button>
            </div>

            <div class="input-group mb-3 shadow-sm">
                <span class="input-group-text bg-white border-end-0 search-box"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="buscadorInput" class="form-control border-start-0 search-box" placeholder="üîç Buscar material..." onkeyup="filtrarTabla()">
            </div>

            <div style="max-height: 450px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px;">
                <table class="table table-bordered table-sm table-hover mb-0" id="tabla-exportar-lote1" style="font-size: 0.9rem;">
                    <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                        <tr class="text-center align-middle">
                            <th width="15%">C√≥d.</th>
                            <th class="text-start">Descripci√≥n</th>
                            <th width="10%">Total</th>
                            <th width="10%">Lleg√≥</th>
                            <th width="10%">Falta</th>
                            <th width="10%">Est.</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-lote1">
                        <tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-box border-top border-4 border-info" id="seccion-herramientas">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-info m-0"><i class="fas fa-tools"></i> Checklist Herramientas</h5>
                <button onclick="toggleHerramientas()" class="btn btn-outline-info btn-sm">Ver Detalle</button>
            </div>
            
            <div id="lista-herramientas" style="display:block;">
                <div class="mb-3 d-flex flex-wrap">
                    <button onclick="enviarWhatsApp('Herramientas', 'tabla-herramientas')" class="btn btn-whatsapp btn-action"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                    <button onclick="exportarExcel('tabla-exportar-herramientas', 'Reporte_Herramientas')" class="btn btn-excel btn-action"><i class="fas fa-file-excel"></i> Excel</button>
                    <button onclick="exportarPDF('tabla-exportar-herramientas', 'Reporte Herramientas')" class="btn btn-pdf btn-action"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button onclick="imprimirTabla('seccion-herramientas')" class="btn btn-secondary btn-action"><i class="fas fa-print"></i> Imprimir</button>
                </div>

                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px;">
                    <table class="table table-striped table-sm mb-0" id="tabla-exportar-herramientas" style="font-size: 0.9rem;">
                        <thead class="table-light" style="position: sticky; top: 0;">
                            <tr class="text-center align-middle">
                                <th width="10%">Item</th>
                                <th class="text-start">Herramienta</th>
                                <th width="15%">Total</th>
                                <th width="15%">Lleg√≥</th>
                                <th width="15%">Falta</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-herramientas">
                            <tr><td colspan="5" class="text-center py-3">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ====================== TUS ENLACES ======================
        const timestamp = new Date().getTime(); // Truco anti-cach√©
        
        const URL_OBLIGACIONES = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTw5wsNPW2SZyorWh9hOoHe2LcZgKkdpS29OziFQFPs-Oh1g9yCP8yNSVwAtk8SETKBbRkqmE47l_co/pub?gid=0&single=true&output=csv&t=' + timestamp;
        
        const URL_LOTE1 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTw5wsNPW2SZyorWh9hOoHe2LcZgKkdpS29OziFQFPs-Oh1g9yCP8yNSVwAtk8SETKBbRkqmE47l_co/pub?gid=1555920355&single=true&output=csv&t=' + timestamp;
        const URL_HERRAMIENTAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTw5wsNPW2SZyorWh9hOoHe2LcZgKkdpS29OziFQFPs-Oh1g9yCP8yNSVwAtk8SETKBbRkqmE47l_co/pub?gid=438228635&single=true&output=csv&t=' + timestamp;
        // =========================================================

        function parsearCSV(texto) {
            const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
            return texto.split(regex);
        }

        // --- 1. CARGAR OBLIGACIONES ---
        async function cargarObligaciones() {
            const tabla = document.getElementById('tabla-obligaciones');
            try {
                const response = await fetch(URL_OBLIGACIONES);
                const data = await response.text();
                // Ojo: Aqu√≠ quitamos slice(1) para asegurarnos de controlar nosotros qu√© fila es header
                const filas = data.split(/\r?\n/);
                tabla.innerHTML = '';

                filas.forEach((fila, index) => {
                    let col = parsearCSV(fila);
                    if(col.length < 5) return; 

                    // A(Item), B(Obligacion), C(Limite), D(Presentacion), E(Estado)
                    const item = col[0].trim();
                    const desc = col[1].replace(/"/g, '').trim();
                    const fechaLim = col[2].replace(/"/g, '').trim();
                    const fechaPres = col[3].replace(/"/g, '').trim();
                    const estado = col[4].replace(/"/g, '').trim();

                    // --- FILTRO: SI ES EL T√çTULO, LO SALTAMOS ---
                    // Esto evita que se repita la fila de encabezados dentro de la tabla
                    if (item.toLowerCase() === 'item' || desc.toLowerCase() === 'obligacion' || item === 'A') {
                        return;
                    }

                    // Colores de estado
                    let badgeClass = "bg-secondary";
                    if(estado.toLowerCase().includes("pendiente")) badgeClass = "badge-pendiente";
                    else if(estado.toLowerCase().includes("proceso")) badgeClass = "badge-proceso";
                    else if(estado.toLowerCase().includes("cumpli") || estado.toLowerCase().includes("ok")) badgeClass = "badge-cumplido";

                    tabla.innerHTML += `
                        <tr>
                            <td class="fw-bold text-center">${item}</td>
                            <td>${desc}</td>
                            <td class="text-center text-danger small fw-bold">${fechaLim}</td>
                            <td class="text-center small">${fechaPres}</td>
                            <td class="text-center"><span class="badge ${badgeClass}">${estado}</span></td>
                        </tr>`;
                });
            } catch (e) { 
                console.error(e); 
                tabla.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No se pudo cargar obligaciones.</td></tr>';
            }
        }

        // --- 2. CARGAR LOTE 1 ---
        async function cargarLote1() {
            const tabla = document.getElementById('tabla-lote1');
            try {
                const response = await fetch(URL_LOTE1);
                const data = await response.text();
                const filas = data.split(/\r?\n/).slice(1);
                
                let totalItems = 0; let totalLlegados = 0;
                let filasValidas = 0;
                tabla.innerHTML = '';

                filas.forEach(fila => {
                    let col = parsearCSV(fila);
                    if(col.length < 4) return;

                    const cod = col[0].trim();
                    const desc = col[1].replace(/"/g, '').trim();
                    const tot = parseFloat(col[2].replace(/"/g, '')) || 0;
                    const llego = parseFloat(col[3].replace(/"/g, '')) || 0;

                    if (tot <= 0 && llego <= 0) return; 

                    filasValidas++;
                    totalItems += tot;
                    totalLlegados += llego;

                    let falta = tot - llego;
                    if (falta < 0) falta = 0;
                    let estiloFalta = (falta > 0) ? "text-faltante" : "text-completo";
                    let valFalta = (falta > 0) ? falta : "-";

                    let estado = "<span class='text-danger'>üî¥</span>"; 
                    if (llego >= tot) estado = "<span class='text-success'>‚úÖ</span>"; 
                    else if (llego > 0) estado = "üöö"; 

                    tabla.innerHTML += `
                        <tr>
                            <td><small class="text-muted fw-bold">${cod}</small></td>
                            <td>${desc}</td>
                            <td class="text-center bg-light">${tot}</td>
                            <td class="text-center fw-bold">${llego}</td>
                            <td class="text-center ${estiloFalta}">${valFalta}</td>
                            <td class="text-center h5 m-0">${estado}</td>
                        </tr>`;
                });

                if (filasValidas === 0) tabla.innerHTML = '<tr><td colspan="6" class="text-center text-danger">‚ö†Ô∏è Sin datos.</td></tr>';

                const porc = totalItems > 0 ? Math.round((totalLlegados / totalItems) * 100) : 0;
                const barra = document.getElementById('barra-lote1');
                barra.style.width = porc + "%";
                barra.innerText = porc + "% RECIBIDO";
                if(porc < 30) barra.className = "progress-bar bg-danger";
                else if(porc < 99) barra.className = "progress-bar bg-warning text-dark";
                else barra.className = "progress-bar bg-success";

            } catch (e) { console.error(e); }
        }

        // --- 3. CARGAR HERRAMIENTAS ---
        async function cargarHerramientas() {
            const tabla = document.getElementById('tabla-herramientas');
            try {
                const response = await fetch(URL_HERRAMIENTAS);
                const data = await response.text();
                const filas = data.split(/\r?\n/).slice(1);
                tabla.innerHTML = '';

                filas.forEach(fila => {
                    let col = parsearCSV(fila);
                    if(col.length < 4) return;
                    
                    const item = col[0].trim();
                    const desc = col[1].replace(/"/g, '').trim();
                    const tot = parseFloat(col[2].replace(/"/g, '')) || 0;
                    const verif = parseFloat(col[3].replace(/"/g, '')) || 0;
                    
                    if(tot <= 0) return;

                    let falta = tot - verif;
                    if (falta < 0) falta = 0;
                    let estiloFalta = (falta > 0) ? "text-danger fw-bold" : "text-muted";
                    let valFalta = (falta > 0) ? falta : "-";

                    tabla.innerHTML += `
                        <tr>
                            <td class="text-center"><small>${item}</small></td>
                            <td>${desc}</td>
                            <td class="text-center bg-light">${tot}</td>
                            <td class="text-center fw-bold">${verif}</td>
                            <td class="text-center ${estiloFalta}">${valFalta}</td>
                        </tr>`;
                });
            } catch (e) { console.error(e); }
        }

        // --- EXPORTACI√ìN ---
        function enviarWhatsApp(nombreReporte, tablaId) {
            let mensaje = `*REPORTE: ${nombreReporte}*\n\n`;
            let faltantes = [];
            let totalGeneral = 0; let totalLlegado = 0;
            const filas = document.getElementById(tablaId).getElementsByTagName('tr');
            
            for (let i = 0; i < filas.length; i++) {
                const celdas = filas[i].getElementsByTagName('td');
                if (celdas.length > 2) {
                    let desc = celdas[1].innerText;
                    let tot = parseFloat(celdas[2].innerText) || 0;
                    let llego = parseFloat(celdas[3].innerText) || 0;
                    let falta = parseFloat(celdas[4].innerText) || (tot - llego);
                    totalGeneral += tot; totalLlegado += llego;
                    if (falta > 0 || celdas[4].innerText !== "-") faltantes.push(`- ${desc}: Faltan ${falta}`);
                }
            }
            let avance = totalGeneral > 0 ? Math.round((totalLlegado / totalGeneral) * 100) : 0;
            mensaje += `üìä *Avance:* ${avance}%\nüì¶ *Recibido:* ${totalLlegado}/${totalGeneral}\n\n`;
            if(faltantes.length > 0) mensaje += `‚ö†Ô∏è *PENDIENTES:*\n${faltantes.join('\n')}`;
            else mensaje += `‚úÖ *¬°Todo completo!*`;

            window.open(`https://wa.me/?text=${encodeURIComponent(mensaje)}`, '_blank');
        }

        function exportarExcel(tablaId, nombreArchivo) {
            const tabla = document.getElementById(tablaId);
            const wb = XLSX.utils.table_to_book(tabla, {sheet: "Data"});
            XLSX.writeFile(wb, `${nombreArchivo}.xlsx`);
        }

        function exportarPDF(tablaId, titulo) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(titulo, 14, 15);
            doc.setFontSize(10);
            doc.text("Fecha: " + new Date().toLocaleDateString(), 14, 22);
            doc.autoTable({ html: '#' + tablaId, startY: 30 });
            doc.save(`${titulo}.pdf`);
        }

        function imprimirTabla(divId) {
            const contenido = document.getElementById(divId).innerHTML;
            const ventana = window.open('', '', 'height=600,width=800');
            ventana.document.write('<html><head><title>Imprimir</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"></head><body><div class="container mt-4">');
            ventana.document.write(contenido);
            ventana.document.write('</div></body></html>');
            ventana.document.close();
            ventana.focus();
            setTimeout(() => { ventana.print(); }, 1000);
        }

        function filtrarTabla() {
            var input = document.getElementById("buscadorInput");
            var filter = input.value.toUpperCase();
            var table = document.getElementById("tabla-lote1");
            var tr = table.getElementsByTagName("tr");
            for (var i = 0; i < tr.length; i++) {
                var td = tr[i].getElementsByTagName("td")[1];
                if (td) {
                    var txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) tr[i].style.display = "";
                    else tr[i].style.display = "none";
                }
            }
        }

        function toggleHerramientas() {
            const x = document.getElementById("lista-herramientas");
            x.style.display = x.style.display === "none" ? "block" : "none";
        }

        cargarObligaciones();
        cargarLote1();
        cargarHerramientas();
    </script>
</body>
</html>
