<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almac√©n y Suministros | Contrato 113</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f4f6f9; padding-bottom: 50px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .header-almacen { background: linear-gradient(90deg, #0d6efd 0%, #0043a8 100%); color: white; padding: 15px 0; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Barra de Progreso */
        .progress-bar { transition: width 1.5s ease-in-out; font-weight: bold; }
        
        /* Estilos de Tabla */
        .fila-kit { background-color: #e7f1ff !important; font-weight: bold; border-left: 4px solid #0d6efd; }
        .text-faltante { color: #dc3545; font-weight: 700; } /* Rojo Fuerte */
        .text-completo { color: #adb5bd; font-size: 0.9em; } /* Gris suave */
        
        /* Buscador */
        .search-box { border-radius: 20px; }
    </style>
</head>
<body>

    <div class="header-almacen">
        <div class="container d-flex justify-content-between align-items-center">
            <h4 class="m-0"><i class="fas fa-boxes"></i> CONTROL DE ALMAC√âN</h4>
            <a href="index.html" class="btn btn-light btn-sm fw-bold shadow-sm"><i class="fas fa-arrow-left"></i> Volver al Inicio</a>
        </div>
    </div>

    <div class="container">

        <div class="card-box">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="text-primary m-0"><i class="fas fa-truck-loading"></i> Recepci√≥n 1ra Entrega (Lote 1)</h5>
                <span class="badge bg-light text-dark border">En tiempo real</span>
            </div>
            <p class="text-muted small">Control de recepci√≥n de bultos y estructuras principales.</p>
            
            <div class="progress" style="height: 25px; margin-bottom: 15px; border-radius: 10px; background-color: #e9ecef;">
                <div id="barra-lote1" class="progress-bar bg-secondary" role="progressbar" style="width: 0%;">Cargando...</div>
            </div>

            <div class="input-group mb-3 shadow-sm">
                <span class="input-group-text bg-white border-end-0 search-box"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="buscadorInput" class="form-control border-start-0 search-box" placeholder="üîç Buscar material... (Ej: Perno, Viga, CB200)" onkeyup="filtrarTabla()">
            </div>

            <div style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px;">
                <table class="table table-bordered table-sm table-hover mb-0" style="font-size: 0.9rem;">
                    <thead class="table-light" style="position: sticky; top: 0; z-index: 10;">
                        <tr class="text-center align-middle">
                            <th style="width: 15%;">C√≥d.</th>
                            <th class="text-start">Descripci√≥n</th>
                            <th style="width: 10%;">Total</th>
                            <th style="width: 10%;">Lleg√≥</th>
                            <th style="width: 10%;">Falta</th> <th style="width: 10%;">Est.</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-lote1">
                        <tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><br>Conectando con la Base de Datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-box border-top border-4 border-info">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="text-info m-0"><i class="fas fa-tools"></i> Checklist del Kit de Herramientas</h5>
                <button onclick="toggleHerramientas()" class="btn btn-outline-info btn-sm">Mostrar / Ocultar Detalle</button>
            </div>
            
            <div id="lista-herramientas" style="display:none;">
                <div class="alert alert-warning py-1 small"><i class="fas fa-info-circle"></i> Verificar contenido al abrir los bultos del Kit.</div>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-striped table-sm mb-0">
                        <thead class="table-light" style="position: sticky; top: 0;">
                            <tr>
                                <th>Item</th>
                                <th>Herramienta</th>
                                <th>Req.</th>
                                <th>Verif.</th>
                                <th>Falta</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-herramientas">
                            <tr><td colspan="5" class="text-center">Cargando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- 1. TUS ENLACES DE GOOGLE SHEETS ---
        const URL_LOTE1 = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTw5wsNPW2SZyorWh9hOoHe2LcZgKkdpS29OziFQFPs-Oh1g9yCP8yNSVwAtk8SETKBbRkqmE47l_co/pub?gid=1555920355&single=true&output=csv';
        const URL_HERRAMIENTAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTw5wsNPW2SZyorWh9hOoHe2LcZgKkdpS29OziFQFPs-Oh1g9yCP8yNSVwAtk8SETKBbRkqmE47l_co/pub?gid=438228635&single=true&output=csv';

        // --- 2. FUNCI√ìN DE CARGA BLINDADA (LOTE 1) ---
        async function cargarLote1() {
            const tabla = document.getElementById('tabla-lote1');
            try {
                const response = await fetch(URL_LOTE1);
                
                if (!response.ok) throw new Error("Google Sheets no responde (" + response.status + ")");
                
                const data = await response.text();
                // Separar filas de forma segura (detecta saltos de l√≠nea de Windows o Mac)
                const filas = data.split(/\r?\n/).slice(1);
                
                let totalItems = 0; let totalLlegados = 0;
                let filasValidas = 0;
                tabla.innerHTML = '';

                filas.forEach(fila => {
                    let col = fila.split(',');
                    // Saltar filas rotas o muy cortas
                    if(col.length < 3) return;

                    // --- TRUCO PARA LEER DESCRIPCIONES CON COMAS ---
                    const cod = col[0].trim();
                    const llegoRaw = col.pop();     // La √∫ltima columna siempre es "Lleg√≥"
                    const totalRaw = col.pop();     // La pen√∫ltima siempre es "Total"
                    col.shift();                    // Quitamos el c√≥digo del inicio
                    const desc = col.join(', ').replace(/"/g, '').trim(); // Lo del medio es descripci√≥n

                    // Convertir textos a n√∫meros
                    const tot = parseFloat(totalRaw) || 0;
                    const llego = parseFloat(llegoRaw) || 0;

                    // --- FILTRO IMPORTANTE: Si Total es 0, ignorar fila ---
                    if (tot <= 0) return;

                    filasValidas++;
                    totalItems += tot;
                    totalLlegados += llego;

                    // C√°lculos
                    let falta = tot - llego;
                    if (falta < 0) falta = 0; // Por si llega de m√°s

                    // Estilos visuales para "Faltante"
                    let estiloFalta = (falta > 0) ? "text-faltante" : "text-completo";
                    let valFalta = (falta > 0) ? falta : "-";

                    // Detectar si es el KIT (Caja azul)
                    let claseFila = "";
                    let icono = "";
                    if(desc && (desc.toLowerCase().includes("kit") || desc.toLowerCase().includes("paquete"))) {
                        claseFila = "fila-kit";
                        icono = "üì¶ ";
                    }

                    // Sem√°foro visual
                    let estado = "<span class='text-danger'>üî¥</span>"; 
                    if (llego >= tot) estado = "<span class='text-success'>‚úÖ</span>"; 
                    else if (llego > 0) estado = "üöö"; 

                    // Dibujar la fila
                    tabla.innerHTML += `
                        <tr class="${claseFila}">
                            <td><small class="text-muted fw-bold">${cod}</small></td>
                            <td>${icono}${desc}</td>
                            <td class="text-center bg-light">${tot}</td>
                            <td class="text-center fw-bold">${llego}</td>
                            <td class="text-center ${estiloFalta}">${valFalta}</td>
                            <td class="text-center h5 m-0">${estado}</td>
                        </tr>`;
                });

                // Si no encontr√≥ nada v√°lido, avisar
                if (filasValidas === 0) {
                     tabla.innerHTML = '<tr><td colspan="6" class="text-center text-danger p-3 fw-bold">‚ö†Ô∏è No se encontraron datos v√°lidos.<br><small class="text-muted">Verifica que hayas borrado los pesos de la columna D en el Excel y que la columna C tenga cantidades.</small></td></tr>';
                }

                // Actualizar Barra de Progreso
                const porc = totalItems > 0 ? Math.round((totalLlegados / totalItems) * 100) : 0;
                const barra = document.getElementById('barra-lote1');
                barra.style.width = porc + "%";
                barra.innerText = porc + "% RECIBIDO";
                
                // Colores de la barra
                if(porc < 30) { barra.className = "progress-bar bg-danger"; }
                else if(porc < 99) { barra.className = "progress-bar bg-warning text-dark"; }
                else { barra.className = "progress-bar bg-success"; }

            } catch (e) { 
                console.error(e);
                tabla.innerHTML = `<tr><td colspan="6" class="text-center text-danger p-3"><i class="fas fa-exclamation-triangle"></i> <strong>Error de Conexi√≥n:</strong><br>${e.message}<br><small>Revisa tu internet o el enlace de Google Sheets.</small></td></tr>`;
            }
        }

        // --- 3. CARGA DE HERRAMIENTAS ---
        async function cargarHerramientas() {
            const tabla = document.getElementById('tabla-herramientas');
            try {
                const response = await fetch(URL_HERRAMIENTAS);
                if (!response.ok) return; 
                
                const data = await response.text();
                const filas = data.split(/\r?\n/).slice(1);
                tabla.innerHTML = '';

                filas.forEach(fila => {
                    let col = fila.split(',');
                    if(col.length < 3) return;
                    
                    const item = col[0];
                    const desc = col[1];
                    const tot = parseFloat(col[2]) || 0;
                    const verif = parseFloat(col[3]) || 0;
                    
                    if(tot <= 0) return; // Saltar vac√≠os

                    let falta = tot - verif;
                    if (falta < 0) falta = 0;
                    
                    let estiloFalta = (falta > 0) ? "text-danger fw-bold" : "text-muted";
                    let valFalta = (falta > 0) ? falta : "-";
                    const check = verif >= tot ? '<span class="badge bg-success">OK</span>' : '<span class="badge bg-secondary">Pend.</span>';

                    tabla.innerHTML += `
                        <tr>
                            <td>${item}</td>
                            <td>${desc}</td>
                            <td>${tot}</td>
                            <td>${verif} ${check}</td>
                            <td class="${estiloFalta}">${valFalta}</td>
                        </tr>`;
                });
            } catch (e) { 
                tabla.innerHTML = `<tr><td colspan="5" class="text-danger">No se pudo cargar la lista de herramientas.</td></tr>`;
            }
        }

        // --- 4. FUNCIONES DE INTERFAZ ---
        function filtrarTabla() {
            var input = document.getElementById("buscadorInput");
            var filter = input.value.toUpperCase();
            var table = document.getElementById("tabla-lote1");
            var tr = table.getElementsByTagName("tr");

            for (var i = 0; i < tr.length; i++) {
                var tdCodigo = tr[i].getElementsByTagName("td")[0];
                var tdDesc = tr[i].getElementsByTagName("td")[1];
                if (tdCodigo || tdDesc) {
                    var txtValue = (tdCodigo.textContent || tdCodigo.innerText) + " " + (tdDesc.textContent || tdDesc.innerText);
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

        function toggleHerramientas() {
            const x = document.getElementById("lista-herramientas");
            x.style.display = x.style.display === "none" ? "block" : "none";
        }

        // INICIAR AL CARGAR LA P√ÅGINA
        cargarLote1();
        cargarHerramientas();
    </script>
</body>
</html>
